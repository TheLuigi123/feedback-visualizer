<!DOCTYPE html>
<html>
<head>
    <title>Feedback Dashboard</title>
    <style>
      /* CSS */
      body {
            font-family: sans-serif;
            text-align: center;
            margin: 0;
            font-size: 2em; /* Base size for the page */
        }
      #date-controls {
          margin-bottom: 20px;
          padding-top: 30px;
          padding-bottom: 15px;
      }
      #date-display {
          font-size: 1.5em; /* Relative to body: 1.5 * 2em = 3em */
          margin: 0 10px;
       }
      .arrow {
          cursor: pointer;
          font-size: 1.5em; /* Relative to body: 1.5 * 2em = 3em */
          padding: 5px;
       }
      #group-counts {
        margin-top: 20px;
        text-align: left;
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
        min-height: 50px;
        vertical-align: top;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }

      #comments-display {
        text-align: left;
        margin-top: 20px;
        width: 100%;
        padding: 0 10px;
        box-sizing: border-box;
        /* REMOVED font-size rule - inherits 2em from body */
      }
      .group-count {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
      .group-name { /* Inherits 2em from body */
            white-space: nowrap;
            width: 120px;
            text-align: left;
            flex-shrink: 0;
            margin-right: 10px;
        }
      .bar-chart {
            display: flex;
            width: 100%; /* Fill available space */
            height: 20px; /* Height of the bar container */
            border: 1px solid #eee;
            overflow: hidden;
            margin-left: 60px; /* Space to the left of the bar chart */
        }

      .bar { height: 100%; } /* Fills the height of .bar-chart */
      .button-1 { background-color: green; }
      .button-2 { background-color: yellow; }
      .button-3 { background-color: red; }
      .group-total { /* Inherits 2em from body via parent */
          font-size: 0.9em; /* Relative to inherited 2em = 1.8em */
          padding-left: 40px;
          text-align: left;
          white-space: nowrap;
       }
    </style>
</head>
<body>

    <div id="date-controls">
        <span class="arrow" onclick="changeDate(-1)"><</span>
        <span id="date-display">Loading...</span>
        <span class="arrow" onclick="changeDate(1)">></span>
    </div>

    <div id="group-counts">Initializing...</div>

    <hr style="margin: 20px 0;">
    <div id="comments-display"></div> <!-- Comments will inherit 2em -->

    <!-- Step 1: Load the GAPI library -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gisLoaded()"></script>

    <script>
        // --- Helper Functions ---
        function formatDate(date) {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = String(date.getFullYear()).slice(2);
          return `${day}/${month}/${year}`;
        }

        function getWeekday(date) {
          return weekdays[date.getDay()];
        }

        function calculateGlobalMax(allData) {
          const dailyGroupTotals = {};
          let maxFound = 0;

          if (allData && allData.length > 1) {
            for (let i = 1; i < allData.length; i++) {
              const row = allData[i];
              if (!row || row.length < 2 || !row[0] || !row[1]) continue;

              const timestamp = row[0];
              const group = row[1];
              let datePart = '';

              if (typeof timestamp === 'string') {
                  datePart = timestamp.split(' ')[0];
              } else { continue; }

              if (!/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(datePart)) continue;

              if (!dailyGroupTotals[datePart]) dailyGroupTotals[datePart] = {};
              if (!dailyGroupTotals[datePart][group]) dailyGroupTotals[datePart][group] = 0;

              dailyGroupTotals[datePart][group]++;

              if (dailyGroupTotals[datePart][group] > maxFound) {
                maxFound = dailyGroupTotals[datePart][group];
              }
            }
          }
          console.log("Global Max Daily Group Count Calculated:", maxFound);
          return maxFound;
        }

        function updateStatus(message, isError = false) {
            console[isError ? 'error' : 'log']("Status:", message);
            const groupCountsContainer = document.getElementById('group-counts');
            const commentsContainer = document.getElementById('comments-display');

            if (groupCountsContainer) {
                groupCountsContainer.textContent = message;
            }
            if (commentsContainer) {
                commentsContainer.innerHTML = message;
            }

            if (isError) {
                document.getElementById('date-display').textContent = "Error";
            } else {
                 if (message !== "Initializing API client..." && message !== "Loading API modules..." && message !== "Fetching data to calculate scale...") {
                     setDateDisplay();
                 } else if (document.getElementById('date-display').textContent === "Loading...") {
                     setDateDisplay();
                 }
            }
        }


        function setDateDisplay() {
          try {
            const weekday = getWeekday(currentDate);
            const formattedDate = formatDate(currentDate);
            document.getElementById('date-display').textContent = `${weekday}, ${formattedDate}`;
          } catch (error) {
            console.error("Error setting date display:", error);
            document.getElementById('date-display').textContent = "Date Error";
          }
        }

        // --- Constants ---
        const SPREADSHEET_ID = '1DIKTyqRujOEF6TbfhxF5UvZvu1O81o0gtF_5DANYbJQ';
        const SHEET_NAME = 'Sheet1';
        const API_KEY = 'AIzaSyDG2mNypu1h7Zl2eQhK2IFBDIBgLvYX1Pk'; // Replace with your actual API key

        console.log("Constants defined - API Key:", API_KEY.substring(0, 10)+"...", "Sheet ID:", SPREADSHEET_ID);

        // --- State Variables ---
        let currentDate = new Date();
        let globalMaxDailyGroupCount = 0;
        let gapiInitialized = false;
        const weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const groupOrder = ["Besucher", "Lehrer", "9-12 Klasse", "5-8 Klasse", "1-4 Klasse"];
        const buttonNumbers = [1, 2, 3];

        // --- Initialization Flow ---

        function gisLoaded() {
            console.log("GAPI script loaded (gisLoaded called). Loading 'client:auth2' modules...");
            updateStatus("Loading API modules...");
            gapi.load('client:auth2', initializeGapiClient);
        }

        function initializeGapiClient() {
            console.log("'client:auth2' modules loaded. Initializing GAPI client...");
            updateStatus("Initializing API client...");

            try {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                }).then(() => {
                    console.log("gapi.client.init promise resolved successfully.");
                    if (gapi.client.sheets && gapi.client.sheets.spreadsheets) {
                        console.log("Sheets API client (gapi.client.sheets) is available.");
                        gapiInitialized = true;
                        updateStatus("Fetching data to calculate scale...");
                        fetchDataForScaleCalculation();
                    } else {
                        console.error("gapi.client.init succeeded BUT gapi.client.sheets is NOT available!");
                        updateStatus("Error: Sheets API structure not found after init.", true);
                        gapiInitialized = false;
                    }
                }).catch(err => {
                    console.error("Error during gapi.client.init promise:", err);
                    handleInitError(err);
                    gapiInitialized = false;
                });
                console.log("gapi.client.init call was issued (asynchronously).");
            } catch (error) {
                console.error("Synchronous error during gapi.client.init setup:", error);
                updateStatus("Critical initialization error: " + error.message, true);
                gapiInitialized = false;
                document.getElementById("date-display").textContent = "Init Error";
            }
        }

        function handleInitError(err) {
            let errorMsg = err.result?.error?.message || err.message || 'Unknown init error';
            if (err.result?.error?.status === 'PERMISSION_DENIED') { errorMsg += ". Check API Key restrictions or Sheet permissions."; }
            else if (err.result?.error?.status === 'INVALID_ARGUMENT') { errorMsg += ". Check Spreadsheet ID or Sheet Name."; }
            else { errorMsg += ". Check API Key, Spreadsheet ID, Discovery Doc URL, Network, & Sheet Permissions."; }
            updateStatus(`Initialization Error: ${errorMsg}`, true);
        }

        function fetchDataForScaleCalculation() {
            if (!gapiInitialized) {
                updateStatus("Error: Cannot fetch scale data, GAPI not initialized.", true);
                return;
            }

            console.log("Fetching A:B range for scale calculation...");
            try {
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME}!A:B`,
                    dateTimeRenderOption: 'FORMATTED_STRING'
                }).then(response => {
                    console.log("Successfully fetched A:B data.");
                    const allData = response.result.values;
                    globalMaxDailyGroupCount = calculateGlobalMax(allData);

                    if (globalMaxDailyGroupCount === 0) {
                        console.warn("No data found or max count is zero after scale calculation.");
                        updateStatus("No feedback data found in the sheet.");
                    } else {
                        console.log("Scale calculated. Displaying initial data for today.");
                        displayGroupCounts();
                    }
                }).catch(err => {
                    console.error("Error fetching A:B data:", err);
                    updateStatus(`Error fetching scale data: ${err.result?.error?.message || err.message}`, true);
                });
            } catch (error) {
                console.error("Synchronous error calling sheets.spreadsheets.values.get for scale:", error);
                updateStatus(`Critical Error fetching scale data: ${error.message}`, true);
            }
        }

        function displayGroupCounts() {
            try {
                if (!gapiInitialized) {
                    updateStatus("Error: Cannot display counts, GAPI not initialized.", true);
                    return;
                }

                if (globalMaxDailyGroupCount <= 0) {
                    if (!document.getElementById('group-counts').textContent.includes("Error") && !document.getElementById('group-counts').textContent.includes("No feedback data")) {
                       updateStatus("Scale calculation pending or failed.");
                    }
                    console.warn("Cannot display: Global max count is zero or not calculated.");
                    const commentsContainer = document.getElementById('comments-display');
                     if(commentsContainer) commentsContainer.innerHTML = "";
                    return;
                }

                const formattedDate = formatDate(currentDate);
                const range = `${SHEET_NAME}!A:E`;
                const groupCountsContainer = document.getElementById('group-counts');
                const commentsContainer = document.getElementById('comments-display');

                groupCountsContainer.innerHTML = "Loading day data...";
                commentsContainer.innerHTML = "";

                console.log(`Fetching A:E range for date: ${formattedDate}...`);

                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    dateTimeRenderOption: 'FORMATTED_STRING'
                }).then(response => {
                    console.log(`Successfully fetched A:E data for ${formattedDate}.`);
                    groupCountsContainer.innerHTML = "";

                    const data = response.result.values;
                    const groupButtonCounts = {};
                    const groupTotals = {};
                    const groupComments = {};
                    let foundDataForDate = false;

                    if (data && data.length > 1) {
                        for (let i = 1; i < data.length; i++) {
                            const row = data[i];
                            if (!row || row.length < 3) continue;

                            const timestamp = row[0];
                            const group = row[1];
                            const button = parseInt(row[2]);
                            const comment = (row.length > 4 && row[4]) ? String(row[4]).trim() : null;

                            if (timestamp && typeof timestamp === 'string' && timestamp.startsWith(formattedDate) && group && !isNaN(button) && buttonNumbers.includes(button)) {
                                foundDataForDate = true;

                                if (!groupButtonCounts[group]) groupButtonCounts[group] = {};
                                groupButtonCounts[group][button] = (groupButtonCounts[group][button] || 0) + 1;
                                groupTotals[group] = (groupTotals[group] || 0) + 1;

                                if (comment && comment.length > 0) {
                                    if (!groupComments[group]) groupComments[group] = [];
                                    groupComments[group].push(comment);
                                }
                            }
                        }
                    }

                    // --- Render Group Counts and Bars ---
                    if (foundDataForDate) {
                        groupOrder.forEach(group => {
                            const totalCountForDay = groupTotals[group] || 0;
                            if (totalCountForDay > 0) {
                                const groupCountDiv = document.createElement('div');
                                groupCountDiv.className = 'group-count';

                                const groupNameSpan = document.createElement('span');
                                groupNameSpan.className = 'group-name';
                                groupNameSpan.textContent = `${group}:`;
                                groupCountDiv.appendChild(groupNameSpan);

                                const barChartDiv = document.createElement('div');
                                barChartDiv.className = 'bar-chart';

                                buttonNumbers.forEach(button => {
                                    const buttonCountForDay = groupButtonCounts[group]?.[button] || 0;
                                    const percentage = globalMaxDailyGroupCount > 0 ? (buttonCountForDay / globalMaxDailyGroupCount) * 100 : 0;
                                    if (percentage > 0) {
                                        const barDiv = document.createElement('div');
                                        barDiv.className = `bar button-${button}`;
                                        barDiv.style.width = `${percentage}%`;
                                        barDiv.title = `${buttonCountForDay}`;
                                        barChartDiv.appendChild(barDiv);
                                    }
                                });
                                groupCountDiv.appendChild(barChartDiv);

                                const totalCountSpan = document.createElement('span');
                                totalCountSpan.className = 'group-total';
                                totalCountSpan.textContent = `(${totalCountForDay})`;
                                groupCountDiv.appendChild(totalCountSpan);

                                groupCountsContainer.appendChild(groupCountDiv);
                            }
                        });
                    } else {
                        groupCountsContainer.textContent = "No data found for this date.";
                        commentsContainer.innerHTML = "";
                    }


                    // --- Render Comments ---
                    commentsContainer.innerHTML = "";
                    let commentsFoundForAnyGroup = false;
                    groupOrder.forEach(group => {
                        const commentsForGroup = groupComments[group];
                        if (commentsForGroup && commentsForGroup.length > 0) {
                            commentsFoundForAnyGroup = true;
                            const commentBlock = document.createElement('div');
                            // Inherits font size from #comments-display -> body
                            commentBlock.style.marginBottom = '10px';

                            const nameLabel = document.createElement('strong');
                            nameLabel.textContent = `${group}: `;
                            commentBlock.appendChild(nameLabel);

                            commentBlock.appendChild(document.createTextNode(commentsForGroup.join(' | ')));
                            commentsContainer.appendChild(commentBlock);
                        }
                    });

                    if (!commentsFoundForAnyGroup && foundDataForDate) {
                        commentsContainer.textContent = "No comments for this date.";
                    }

                }).catch(err => {
                    console.error(`Error fetching or displaying data for ${formattedDate}:`, err);
                    updateStatus(`Error displaying data: ${err.result?.error?.message || err.message || 'An unknown error occurred'}.`, true);
                });
            } catch (ierr) {
                console.error(`Critical code logic error in displayGroupCounts for ${formatDate(currentDate)}:`, ierr);
                updateStatus(`Code error displaying data: ${ierr.message}`, true);
                 const commentsContainer = document.getElementById('comments-display');
                 if(commentsContainer) commentsContainer.innerHTML = `Error displaying comments! (Code Problem)`;
            }
        }

        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            setDateDisplay();

            const groupCountsContainer = document.getElementById('group-counts');
            const commentsContainer = document.getElementById('comments-display');
            if (groupCountsContainer) groupCountsContainer.innerHTML = "Loading day data...";
            if (commentsContainer) commentsContainer.innerHTML = "";

            if (gapiInitialized && globalMaxDailyGroupCount > 0) {
                displayGroupCounts();
            } else if (!gapiInitialized) {
                updateStatus("Cannot change date: GAPI not initialized.", true);
            } else {
                updateStatus("Cannot display data (initialization may have failed or no data found).");
                 if (commentsContainer) commentsContainer.innerHTML = "";
            }
        }

        // --- Initial Load Trigger ---
        setDateDisplay();
        // GAPI script tag calls gisLoaded() via onload attribute

    </script>
</body>
</html>
